<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ ui_title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        font-family: "IBM Plex Sans", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: #0f172a;
        color: #e2e8f0;
      }
      body {
        margin: 0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: 100vh;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        background: #1e293b;
        font-size: 0.85rem;
      }
      main {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
        flex: 1;
      }
      .panel {
        background: #1e293b;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      .messages {
        list-style: none;
        margin: 0;
        padding: 0;
        max-height: 55vh;
        overflow-y: auto;
      }
      .messages li {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        background: #0f172a;
      }
      .messages li .meta {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-bottom: 0.2rem;
      }
      form {
        display: flex;
        gap: 0.5rem;
      }
      input[type="text"] {
        flex: 1;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: none;
        font-size: 1rem;
        background: #0f172a;
        color: #f1f5f9;
      }
      button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        background: #38bdf8;
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: wait;
      }
      .diag-grid {
        font-size: 0.85rem;
      }
      .diag-grid dt {
        font-weight: 600;
      }
      .diag-grid dd {
        margin: 0 0 0.5rem 0;
        color: #94a3b8;
      }
      .plan-controls {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
      }
      footer {
        font-size: 0.85rem;
        color: #94a3b8;
        text-align: center;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>{{ ui_title }}</h1>
        <p>Web control surface for the BehaviorTree mission coordinator</p>
      </div>
      <div class="badge">
        Active subtree:
        <strong id="active-subtree">{{ active_subtree }}</strong>
      </div>
    </header>

    <main>
      <section class="panel">
        <h2>Chat</h2>
        <ul class="messages" id="messages"></ul>
        <form id="chat-form">
          <input
            type="text"
            name="text"
            id="chat-input"
            placeholder="Type command or /status, /regen, /llm ..."
            autocomplete="off"
          />
          <label style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.85rem;">
            <input type="checkbox" id="auto-run" />
            Auto-run plan
          </label>
          <button type="submit" id="chat-submit">Send</button>
        </form>
      </section>
      <section class="panel">
        <h2>Status</h2>
        <p id="status-text">{{ status }}</p>
        <h3>Diagnostics</h3>
        <dl class="diag-grid" id="diag-grid"></dl>
        <h3>Pending Plan</h3>
        <pre
          id="pending-plan"
          style="max-height: 30vh; overflow-y: auto; background: #0f172a; padding: 0.5rem; border-radius: 0.5rem; font-size: 0.8rem;"
        ></pre>
        <div class="plan-controls">
          <button type="button" id="approve-btn">Run plan</button>
          <button type="button" id="cancel-btn">Cancel plan</button>
        </div>
      </section>
    </main>

    <footer>
      Commands proxy the mission coordinator + llm_interface services configured in
      your ROS params. Demo mode echoes instead of calling ROS APIs.
    </footer>

    <script>
      const messagesEl = document.getElementById("messages");
      const statusEl = document.getElementById("status-text");
      const subtreeEl = document.getElementById("active-subtree");
      const diagEl = document.getElementById("diag-grid");
      const form = document.getElementById("chat-form");
      const input = document.getElementById("chat-input");
      const submitBtn = document.getElementById("chat-submit");
      const autoRunEl = document.getElementById("auto-run");
      const pendingPlanEl = document.getElementById("pending-plan");
      const approveBtn = document.getElementById("approve-btn");
      const cancelBtn = document.getElementById("cancel-btn");

      async function fetchState() {
        const res = await fetch("/state");
        if (!res.ok) return;
        const data = await res.json();
        subtreeEl.textContent = data.active_subtree || "unknown";
        statusEl.textContent = data.status || "unknown";
        renderMessages(data.messages || []);
        renderDiagnostics(data.diagnostics || {});
        renderPendingPlan(data.pending_plan || null);
      }

      function renderMessages(messages) {
        messagesEl.innerHTML = "";
        messages.slice(-100).forEach((msg) => {
          const li = document.createElement("li");
          li.innerHTML = `<div class="meta">${msg.ts} Â· ${
            msg.role
          }</div><div>${escapeHtml(msg.content)}</div>`;
          messagesEl.appendChild(li);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function renderDiagnostics(diag) {
        diagEl.innerHTML = "";
        Object.entries(diag).forEach(([key, value]) => {
          const dt = document.createElement("dt");
          dt.textContent = key;
          const dd = document.createElement("dd");
          dd.textContent = value;
          diagEl.appendChild(dt);
          diagEl.appendChild(dd);
        });
      }

      function renderPendingPlan(plan) {
        if (!plan) {
          pendingPlanEl.textContent = "No pending plan.";
          approveBtn.disabled = true;
          cancelBtn.disabled = true;
          return;
        }
        pendingPlanEl.textContent = JSON.stringify(plan, null, 2);
        const hasSession = !!plan.session_id;
        approveBtn.disabled = !hasSession;
        cancelBtn.disabled = !hasSession;
      }

      function escapeHtml(str) {
        const div = document.createElement("div");
        div.innerText = str;
        return div.innerHTML;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        submitBtn.disabled = true;
        try {
          const res = await fetch("/command", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text, auto_execute: !!autoRunEl.checked }),
          });
          if (res.ok) {
            input.value = "";
            await fetchState();
          } else {
            const detail = await res.json();
            alert(detail.detail || "Failed to send command");
          }
        } finally {
          submitBtn.disabled = false;
          input.focus();
        }
      });

      approveBtn.addEventListener("click", async () => {
        approveBtn.disabled = true;
        cancelBtn.disabled = true;
        try {
          const res = await fetch("/approve", { method: "POST" });
          if (!res.ok) {
            const detail = await res.json();
            alert(detail.detail || "Failed to approve plan");
          }
        } finally {
          await fetchState();
        }
      });

      cancelBtn.addEventListener("click", async () => {
        approveBtn.disabled = true;
        cancelBtn.disabled = true;
        try {
          const res = await fetch("/cancel", { method: "POST" });
          if (!res.ok) {
            const detail = await res.json();
            alert(detail.detail || "Failed to cancel plan");
          }
        } finally {
          await fetchState();
        }
      });

      setInterval(fetchState, 1500);
      fetchState();
    </script>
  </body>
</html>
